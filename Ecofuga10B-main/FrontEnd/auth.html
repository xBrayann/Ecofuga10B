<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Autenticación</title>

  <!-- Estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="shell.css">

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0aa4ff">
  <link rel="icon" href="icons/icon-72.png" type="image/png">

  <style>
    .auth-container {
      max-width: 400px;
      margin: 24px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      background: #fff;
    }
    .lockout-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }
    .lockout-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .lockout-icon {
      font-size: 3rem;
      color: #dc3545;
      margin-bottom: 10px;
    }
    .lockout-message { margin: 10px 0; color: #6c757d; }
    .timer-display { margin: 15px 0; }
    .timer-value { font-size: 1.5rem; font-weight: bold; color: #dc3545; }
    .progress-bar {
      background: #e9ecef;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill { height: 100%; background: #dc3545; transition: width 1s ease; }
    .hidden { display: none; }
    #toggleBtn { text-decoration: none; }
  </style>
</head>
<body>

  <div id="app-header"></div>
  <main id="page-content">
    <div class="container mt-3">
      <div class="auth-container">
        <h2 id="authTitle">{{ isLoginMode ? 'Iniciar Sesión' : 'Registrarse' }}</h2>

        <div id="lockoutTimer" class="lockout-container hidden">
          <div class="lockout-card">
            <div class="lockout-icon">
              <i class="fas fa-lock"></i>
            </div>
            <h3>Cuenta Bloqueada</h3>
            <p class="lockout-message">
              Demasiados intentos fallidos. Por favor espera.
            </p>
            <div class="timer-display">
              <span class="timer-value" id="timer"></span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
        </div>

        <form id="authForm" novalidate>
          <div id="registerFields" class="hidden">
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" id="nombre" name="nombre" class="form-control" autocomplete="name">
            </div>

            <div class="mb-3">
              <label for="direccion" class="form-label">Dirección</label>
              <input type="text" id="direccion" name="direccion" class="form-control" autocomplete="street-address">
            </div>

            <div class="mb-3">
              <label for="telefono" class="form-label">Teléfono</label>
              <input type="tel" id="telefono" name="telefono" class="form-control" autocomplete="tel">
            </div>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" name="email" class="form-control" required autocomplete="email">
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" id="password" name="password" class="form-control" required autocomplete="current-password">
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary w-100">
            {{ isLoginMode ? 'Iniciar Sesión' : 'Registrarse' }}
          </button>
        </form>

        <div id="verificationMessage" class="mt-3 hidden">
          <p>Usuario registrado exitosamente. Por favor verifica tu correo electrónico.</p>
          <button id="resendBtn" class="btn btn-secondary">Reenviar verificación</button>
        </div>

        <button id="toggleBtn" class="btn btn-link w-100 mt-3">
          {{ isLoginMode ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Inicia sesión' }}
        </button>
      </div>
    </div>
  </main>

 
  <script src="shell.js"></script>

  <!-- Lógica de autenticación (Happy/Unhappy path) -->
  <script src="js/auth.js"></script>

  <!-- Service Worker -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
        console.log("✅ Service Worker registrado correctamente:", reg.scope);

        // Aviso de actualización
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              const banner = document.createElement('div');
              banner.style.cssText =
                "position:fixed;left:16px;right:16px;bottom:16px;padding:12px;border-radius:12px;background:#0aa4ff;color:#fff;display:flex;justify-content:space-between;align-items:center;gap:12px;z-index:9999;box-shadow:0 10px 20px rgba(0,0,0,.2)";
              banner.innerHTML = "<span>Hay una actualización disponible.</span>";
              const btn = document.createElement('button');
              btn.textContent = "Actualizar";
              btn.style.cssText =
                "background:#00b894;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer";
              btn.onclick = () => nw.postMessage({ type: 'SKIP_WAITING' });
              banner.appendChild(btn);
              document.body.appendChild(banner);
              navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
            }
          });
        });
      } catch (err) {
        console.error("❌ Error al registrar el Service Worker:", err);
      }
    });
  }
  </script>
</body>
</html>
